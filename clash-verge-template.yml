port: 7890
socks-port: 7891
allow-lan: false
mode: Rule
log-level: info
external-controller: 127.0.0.1:9090
unified-delay: true
hosts:
  time.facebook.com: 17.253.84.125
  time.android.com: 17.253.84.125
dns:
  enable: true
  use-hosts: true
  nameserver:
    - 119.29.29.29
    - 223.5.5.5
    - 223.6.6.6
    - tcp://223.5.5.5
    - tcp://223.6.6.6
    - tls://dns.google:853
    - tls://8.8.8.8:853
    - tls://8.8.4.4:853
    - tls://dns.alidns.com
    - tls://223.5.5.5
    - tls://223.6.6.6
    - tls://dot.pub
    - tls://1.12.12.12
    - tls://120.53.53.53
    - https://dns.google/dns-query
    - https://8.8.8.8/dns-query
    - https://8.8.4.4/dns-query
    - https://dns.alidns.com/dns-query
    - https://223.5.5.5/dns-query
    - https://223.6.6.6/dns-query
    - https://doh.pub/dns-query
    - https://1.12.12.12/dns-query
    - https://120.53.53.53/dns-query
  default-nameserver:
    - 119.29.29.29
    - 223.5.5.5
    - 223.6.6.6
    - tcp://119.29.29.29
    - tcp://223.5.5.5
    - tcp://223.6.6.6
proxies: # LEAVE THIS LINE!
rule-providers:
  reject:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt"
    path: ./ruleset/reject.yaml
    interval: 86400

  microsoft:
    type: http
    format: yaml
    interval: 86400
    behavior: domain
    url: "https://fastly.jsdelivr.net/gh/kitcoun/clash-verge-rule-template@main/ruleset/microsoft.yaml"
    path: "./ruleset/microsoft.yaml"

  icloud:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt"
    path: ./ruleset/icloud.yaml
    interval: 86400

  apple:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt"
    path: ./ruleset/apple.yaml
    interval: 86400

  google:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt"
    path: ./ruleset/google.yaml
    interval: 86400

  proxy:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt"
    path: ./ruleset/proxy.yaml
    interval: 86400

  direct:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt"
    path: ./ruleset/direct.yaml
    interval: 86400

  private:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt"
    path: ./ruleset/private.yaml
    interval: 86400

  gfw:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt"
    path: ./ruleset/gfw.yaml
    interval: 86400

  tld-not-cn:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt"
    path: ./ruleset/tld-not-cn.yaml
    interval: 86400

  telegramcidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt"
    path: ./ruleset/telegramcidr.yaml
    interval: 86400

  cncidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt"
    path: ./ruleset/cncidr.yaml
    interval: 86400

  lancidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt"
    path: ./ruleset/lancidr.yaml
    interval: 86400

  applications:
    type: http
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
    path: ./ruleset/applications.yaml
    interval: 86400

# 代理组 (来自 tun.txt 中的 proxy-groups)
proxy-groups:
  - name: "节点选择"
    type: "select"
    proxies: ["延迟选优", "故障转移"]
    # include-all: true
    # interval: 300
    # timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg"

  - name: "延迟选优"
    type: "url-test"
    interval: 120
    tolerance: 200
    # include-all: true
    timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg"

  - name: "故障转移"
    type: "fallback"
    # include-all: true
    interval: 300
    timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/ambulance.svg"

  - name: "谷歌服务"
    type: "select"
    proxies: ["节点选择", DIRECT]
    # include-all: true
    # interval: 300
    # timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg"

  - name: "微软服务"
    type: "select"
    proxies: [DIRECT, "节点选择"]
    # include-all: true
    # interval: 300
    # timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/microsoft.svg"

  - name: "苹果服务"
    type: "select"
    proxies: [DIRECT, "节点选择"]
    # include-all: true
    # interval: 300
    # timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false

  - name: "漏网之鱼"
    type: "select"
    proxies: [DIRECT,"节点选择", "延迟选优", "故障转移"]
    # include-all: true
    # interval: 300
    # timeout: 3000
    url: "https://www.google.com/generate_204"
    lazy: true
    max-failed-times: 3
    hidden: false
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg"


rules:  
  # 2. 拦截规则（广告、恶意域名优先拒绝）
  - RULE-SET,reject,REJECT
  
  # 3. 私有网络/局域网（本地设备、内网服务直连）
  - RULE-SET,private,DIRECT
  - RULE-SET,lancidr,DIRECT
  
  # 4. 大陆IP/直连规则集（国内服务优先直连）
  - RULE-SET,cncidr,DIRECT
  - RULE-SET,direct,DIRECT
  
  # 5. 特定服务规则（苹果、iCloud 按规则集策略）
  - RULE-SET,apple,苹果服务
  - RULE-SET,icloud,微软服务
  - RULE-SET,microsoft,微软服务
  
  # 6. 需要代理的服务（GFW列表、谷歌服务、非大陆后缀）
  - RULE-SET,gfw,节点选择
  - RULE-SET,google,谷歌服务
  - RULE-SET,telegramcidr,节点选择
  - RULE-SET,tld-not-cn,节点选择
  
  # 7. 兜底代理规则（未匹配到上述规则的域名走代理）
  - RULE-SET,proxy,节点选择
  
  # 8. 最终兜底（所有未匹配规则走直连，避免误代理）
  - MATCH,漏网之鱼